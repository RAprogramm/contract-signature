<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Yew Demo — contract-signature</title>

    <!-- Trunk assets: ДОЛЖЕН быть ровно ОДИН main wasm -->
    <link data-trunk rel="rust" />
    <link data-trunk rel="scss" href="index.scss" />
  </head>
  <body>
    <!-- Бумага (то, что уйдёт в PDF) -->
    <div id="paper" class="paper" aria-label="Документ договора">
      <h2 class="paper__title">Договор оказания услуг</h2>
      <p class="paper__subtitle">Дочитай до конца, чтобы разблокировать чекбокс.</p>

      <!-- Вьюпорт договора (внутренний скролл) -->
      <div id="contract-root" class="contract" aria-live="polite">
        <div class="contract__content">
          <p>1. Предмет договора...</p>
          <p>2. Права и обязанности сторон...</p>
          <p>3. Сроки, порядок сдачи-приемки работ...</p>
          <p>4. Стоимость и порядок расчетов...</p>
          <p>5. Ответственность сторон...</p>
          <p>6. Форс-мажор...</p>
          <p>7. Порядок разрешения споров...</p>
          <p>8. Заключительные положения...</p>

          <div class="contract__spacer"></div>

          <div class="contract__footer">
            <div class="contract__signature-caption">
              <div class="caption">Подпись Заказчика</div>
              <div class="caption__line" aria-hidden="true"></div>
            </div>
            <div class="contract__clear"></div>
          </div>
        </div>

        <!-- Якорь для размещения подписи -->
        <div id="signature-anchor" class="signature-placeholder" aria-label="Место для подписи">
          Место для подписи
        </div>
      </div>
    </div>

    <!-- Панель действий: чекбокс + место для Yew -->
    <div class="gate" role="group" aria-label="Подтверждение прочтения">
      <label class="gate__label">
        <input id="read-checkbox" class="gate__checkbox" type="checkbox" disabled>
        <span class="gate__text">Прочитал, согласен и готов подписать</span>
      </label>

      <div id="app"></div>
    </div>

    <noscript>
      <div class="noscript">Для подписания требуется включить JavaScript.</div>
    </noscript>

    <!-- Внешние либы: подключаем ОДИН раз -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

    <!-- Локальная логика, изолированная модулем -->
    <script type="module">
      // Guard: don't double-bind on hot reloads
      if (!window.__cs_init__) {
        window.__cs_init__ = true;

        // Unlock the checkbox when scrolled to bottom
        const root = document.getElementById('contract-root');
        const checkbox = document.getElementById('read-checkbox');

        function updateGate() {
          if (!root || !checkbox) return;
          if (root.scrollTop + root.clientHeight >= root.scrollHeight - 2) {
            checkbox.disabled = false;
            root.removeEventListener('scroll', updateGate);
          }
        }

        root?.addEventListener('scroll', updateGate, { passive: true });
        updateGate();

        // Export #paper to PDF with solid white background
        window.exportContractToPdf = async function(containerId, filename) {
          const src = document.getElementById(containerId);
          if (!src || !window.jspdf) return;

          if (document.fonts && document.fonts.ready) {
            try { await document.fonts.ready } catch {}
          }

          // Offscreen stage to avoid layout quirks; enforce white bg
          const rect = src.getBoundingClientRect();
          const stage = document.createElement('div');
          Object.assign(stage.style, {
            position: 'fixed',
            left: '-10000px',
            top: '0',
            width: rect.width + 'px',
            background: '#ffffff',
            padding: '0',
            margin: '0',
            boxShadow: 'none',
            borderRadius: '0',
            isolation: 'isolate'
          });

          const clone = src.cloneNode(true);
          const cloneEl = /** @type {HTMLElement} */(clone);
          Object.assign(cloneEl.style, { background: '#ffffff', boxShadow: 'none', borderRadius: '0' });
          cloneEl.querySelectorAll('.paper, .contract').forEach(el => {
            if (el instanceof HTMLElement) {
              el.style.background = '#ffffff';
              el.style.boxShadow = 'none';
            }
          });

          stage.appendChild(cloneEl);
          document.body.appendChild(stage);

          const canvas = await html2canvas(stage, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false,
            removeContainer: true
          });

          // Paint opaque JPEG to kill any alpha
          function toOpaqueJpeg(srcCanvas) {
            const w = srcCanvas.width, h = srcCanvas.height;
            const out = document.createElement('canvas');
            out.width = w; out.height = h;
            const ctx = out.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(srcCanvas, 0, 0);
            return out.toDataURL('image/jpeg', 0.92);
          }

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ unit: 'pt', format: 'a4', putOnlyUsedFonts: true, compress: true });

          const margin = 28;
          const pageW = pdf.internal.pageSize.getWidth();
          const pageH = pdf.internal.pageSize.getHeight();
          const usableW = pageW - margin * 2;

          const imgW = usableW;
          const imgH = (canvas.height * imgW) / canvas.width;

          const paintPageBg = () => {
            pdf.setFillColor(255, 255, 255);
            pdf.setDrawColor(255, 255, 255);
            pdf.rect(0, 0, pageW, pageH, 'F');
          };

          if (imgH <= pageH - margin * 2) {
            paintPageBg();
            pdf.addImage(toOpaqueJpeg(canvas), 'JPEG', margin, margin, imgW, imgH, undefined, 'FAST');
            pdf.save(filename || 'contract.pdf');
            stage.remove();
            return;
          }

          // Pagination
          const usableHpt = pageH - margin * 2;
          const pxPerPt = canvas.height / imgH;
          const slicePx = Math.floor(usableHpt * pxPerPt);

          let yPx = 0;
          const temp = document.createElement('canvas');
          const tctx = temp.getContext('2d');

          while (yPx < canvas.height) {
            const chunk = Math.min(slicePx, canvas.height - yPx);
            temp.width = canvas.width;
            temp.height = chunk;

            tctx.fillStyle = '#ffffff';
            tctx.fillRect(0, 0, temp.width, temp.height);
            tctx.drawImage(canvas, 0, yPx, canvas.width, chunk, 0, 0, temp.width, temp.height);

            const sliceJpeg = temp.toDataURL('image/jpeg', 0.92);
            const sliceHpt = (chunk * imgW) / canvas.width;

            if (yPx > 0) pdf.addPage();
            paintPageBg();
            pdf.addImage(sliceJpeg, 'JPEG', margin, margin, imgW, sliceHpt, undefined, 'FAST');

            yPx += chunk;
          }

          pdf.save(filename || 'contract.pdf');
          stage.remove();
        };
      }
    </script>
  </body>
</html>
